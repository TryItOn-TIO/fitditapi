# Dockerfile.worker (ë””ë²„ê¹… ë° ìµœì¢… í•´ê²° ë²„ì „)

# NVIDIA ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì •ì„±ê³¼ í˜¸í™˜ì„±ì„ í™•ë³´í•©ë‹ˆë‹¤.
FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œ ëŒ€í™”í˜• í”„ë¡¬í”„íŠ¸ê°€ ëœ¨ì§€ ì•Šë„ë¡ ì„¤ì •
ENV DEBIAN_FRONTEND=noninteractive

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ë° Python ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    git wget curl ffmpeg libgl1-mesa-glx \
    python3.10 python3-pip python3.10-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# python3.10ì„ pythonìœ¼ë¡œ ë§í¬í•˜ì—¬ ê¸°ë³¸ ëª…ë ¹ì–´ë¡œ ì‚¬ìš©
RUN ln -s /usr/bin/python3.10 /usr/bin/python
RUN python -m pip install --upgrade pip

# requirements.txtë¥¼ ë¨¼ì € ë³µì‚¬í•˜ì—¬ Docker ì´ë¯¸ì§€ ë¹Œë“œ ìºì‹œë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ í™œìš©
COPY worker_requirements.txt .
# Python ì˜ì¡´ì„± ì„¤ì¹˜
RUN pip install --no-cache-dir -r worker_requirements.txt

# --- ğŸ‘‡ ì—¬ê¸°ê°€ í•µì‹¬ ë””ë²„ê¹… ë‹¨ê³„ì…ë‹ˆë‹¤ ğŸ‘‡ ---
# pip install í›„, ì‹œìŠ¤í…œ ì „ì²´ì—ì„œ 'celery' ì‹¤í–‰ íŒŒì¼ì„ ì°¾ì•„ ê·¸ ê²½ë¡œë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
# ì´ ê²½ë¡œë¥¼ ë³µì‚¬í•˜ì—¬ ì•„ë˜ CMDì— ë¶™ì—¬ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
RUN find / -type f -name "celery"

# ë‚˜ë¨¸ì§€ ëª¨ë“  ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³µì‚¬
COPY . .

# ìœ„ 'find' ëª…ë ¹ìœ¼ë¡œ ì°¾ì€ 'celery'ì˜ ì ˆëŒ€ ê²½ë¡œë¥¼ ì—¬ê¸°ì— ì…ë ¥í•´ì£¼ì„¸ìš”.
# ì˜ˆ: /usr/local/bin/celery ë˜ëŠ” /root/.local/bin/celery ë“±
#CMD ["/usr/local/bin/celery", "-A", "tasks.celery_app", "worker", "-l", "info", "--concurrency=1"]
# --- ğŸ‘‡ ì—¬ê¸°ê°€ ê°€ì¥ ì¤‘ìš”í•œ ìˆ˜ì • ë¶€ë¶„ì…ë‹ˆë‹¤ ğŸ‘‡ ---
# NVIDIAì˜ ê¸°ë³¸ Entrypointë¥¼ ë¬´ì‹œí•˜ê³ ,
# ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì§€ ì•Šê³  ê³„ì† ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
ENTRYPOINT ["/bin/bash", "-c"]
CMD ["tail -f /dev/null"]